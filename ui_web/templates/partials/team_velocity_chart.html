<div class="box">
    <h3 class="title is-4">ðŸ“ˆ Velocity{% if velocity_rolling_avg %} ({{ velocity_rolling_avg }}M Avg){% endif %}</h3>
    <div class="buttons are-small">
        <button class="button {% if velocity_rolling_avg %}is-info{% endif %}"
                hx-get="{% url 'ui_web:team_velocity_chart' %}?member_group_id={{ member_group_id }}{% if not velocity_rolling_avg %}&rolling_avg=3{% endif %}"
                hx-target="#team-velocity-chart-container"
                hx-swap="innerHTML"
                hx-indicator="#loading-indicator">
            Rolling Average
        </button>
    </div>
    <canvas id="teamVelocityChart" width="400" height="200"></canvas>
</div>

<script>
(function() {
    function initTeamVelocityChart() {
        if (typeof Chart === 'undefined') {
            setTimeout(initTeamVelocityChart, 100);
            return;
        }

        if (window.teamVelocityChartInstance) {
            window.teamVelocityChartInstance.destroy();
            window.teamVelocityChartInstance = null;
        }

        var canvas = document.getElementById('teamVelocityChart');
        if (!canvas) {
            return;
        }

        var chartData = {{ month_velocity|safe }};

        if (chartData && chartData.labels && chartData.data) {
            window.teamVelocityChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: chartData.data.map(function(item) {
                        return {
                            label: item.developer,
                            data: item.metrics,
                            borderColor: item.color,
                            backgroundColor: item.color,
                            fill: false,
                            tension: 0.1
                        };
                    })
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            usePointStyle: true,
                            itemSort: function(a, b) { return b.raw - a.raw; }
                        }
                    }
                }
            });
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initTeamVelocityChart);
    } else {
        initTeamVelocityChart();
    }
})();
</script>
