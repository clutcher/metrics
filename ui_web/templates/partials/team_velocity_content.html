{% if error %}
<article class="message is-danger">
    <div class="message-header">
        <p>⚠️ Error Loading Velocity Data</p>
    </div>
    <div class="message-body">
        <p><strong>{{ error }}</strong></p>
        {% if config_help %}
            <p>{{ config_help }}</p>
            <p>Please contact your system administrator to configure the required data source.</p>
        {% else %}
            <p>Please check your configuration or try refreshing the page.</p>
        {% endif %}
    </div>
</article>
{% else %}
<div class="box">
    <h3 class="title is-4">📈 Velocity</h3>
    <canvas id="teamVelocityChart-{{ request.resolver_match.kwargs.team_id|default:'default' }}-{{ request.GET.member_group_id|default:'all' }}" width="400" height="200"></canvas>
</div>

<div class="box">
    <h3 class="title is-4">📊 Resolved Story Points</h3>
    <canvas id="storyPointsChart-{{ request.resolver_match.kwargs.team_id|default:'default' }}-{{ request.GET.member_group_id|default:'all' }}" width="400" height="200"></canvas>
</div>

<script>
{% if not error %}
function initializeTeamVelocityCharts() {
    if (typeof Chart === 'undefined') {
        console.log('Chart.js not loaded yet, waiting...');
        setTimeout(initializeTeamVelocityCharts, 100);
        return;
    }

    const velocityCanvasId = 'teamVelocityChart-{{ request.resolver_match.kwargs.team_id|default:"default" }}-{{ request.GET.member_group_id|default:"all" }}';
    const storyPointsCanvasId = 'storyPointsChart-{{ request.resolver_match.kwargs.team_id|default:"default" }}-{{ request.GET.member_group_id|default:"all" }}';

    if (window.teamVelocityChartInstance) {
        window.teamVelocityChartInstance.destroy();
        window.teamVelocityChartInstance = null;
    }
    if (window.storyPointsChartInstance) {
        window.storyPointsChartInstance.destroy();
        window.storyPointsChartInstance = null;
    }

    const velocityCanvas = document.getElementById(velocityCanvasId);
    const storyPointsCanvas = document.getElementById(storyPointsCanvasId);
    
    if (!velocityCanvas || !storyPointsCanvas) {
        console.error('Canvas elements not found');
        return;
    }

    const velocityCtx = velocityCanvas.getContext('2d');
    const velocityData = {{ month_velocity|safe }};

    if (velocityData && velocityData.labels && velocityData.data) {
        window.teamVelocityChartInstance = new Chart(velocityCtx, {
            type: 'line',
            data: {
                labels: velocityData.labels,
                datasets: velocityData.data.map(item => ({
                    label: item.developer,
                    data: item.metrics,
                    borderColor: item.color,
                    backgroundColor: item.color,
                    fill: false,
                    tension: 0.1
                }))
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        usePointStyle: true,
                        itemSort: (a, b) => b.raw - a.raw
                    }
                }
            }
        });
    }

    const storyPointsCtx = storyPointsCanvas.getContext('2d');
    const storyPointsData = {{ month_sp|safe }};

    if (storyPointsData && storyPointsData.labels && storyPointsData.data) {
        window.storyPointsChartInstance = new Chart(storyPointsCtx, {
            type: 'bar',
            data: {
                labels: storyPointsData.labels,
                datasets: storyPointsData.data.map(item => ({
                    label: item.developer === 'max_sp' ? 'Max Capacity' : item.developer,
                    data: item.metrics,
                    backgroundColor: item.color,
                    borderColor: item.color,
                    borderWidth: 1
                }))
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        usePointStyle: true,
                        itemSort: (a, b) => b.raw - a.raw
                    }
                }
            }
        });
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeTeamVelocityCharts);
} else {
    initializeTeamVelocityCharts();
}
{% endif %}
</script>
{% endif %}