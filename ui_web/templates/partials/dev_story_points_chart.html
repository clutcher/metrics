<div class="box">
    <h3 class="title is-4">ðŸ“Š Developer Story Points (Last 6 Months)</h3>
    <div class="buttons are-small">
        <button class="button" id="showAll-dev-sp">Show All</button>
        <button class="button" id="hideAll-dev-sp">Hide All</button>
    </div>
    <canvas id="storyPointsChart" width="400" height="200"></canvas>
</div>

<script>
(function() {
    function initStoryPointsChart() {
        if (typeof Chart === 'undefined') {
            setTimeout(initStoryPointsChart, 100);
            return;
        }

        var showAllBtn = document.getElementById('showAll-dev-sp');
        var hideAllBtn = document.getElementById('hideAll-dev-sp');

        if (showAllBtn) {
            showAllBtn.addEventListener('click', function() {
                if (window.devStoryPointsChartInstance) {
                    window.devStoryPointsChartInstance.data.datasets.forEach(function(dataset, index) {
                        window.devStoryPointsChartInstance.setDatasetVisibility(index, true);
                    });
                    window.devStoryPointsChartInstance.update();
                }
            });
        }

        if (hideAllBtn) {
            hideAllBtn.addEventListener('click', function() {
                if (window.devStoryPointsChartInstance) {
                    window.devStoryPointsChartInstance.data.datasets.forEach(function(dataset, index) {
                        window.devStoryPointsChartInstance.setDatasetVisibility(index, false);
                    });
                    window.devStoryPointsChartInstance.update();
                }
            });
        }

        if (window.devStoryPointsChartInstance) {
            window.devStoryPointsChartInstance.destroy();
            window.devStoryPointsChartInstance = null;
        }

        var canvas = document.getElementById('storyPointsChart');
        if (!canvas) {
            return;
        }

        var chartData = {{ month_sp|safe }};

        if (chartData && chartData.labels && chartData.data) {
            window.devStoryPointsChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: chartData.data.map(function(item) {
                        return {
                            label: item.developer,
                            data: item.metrics,
                            backgroundColor: item.color,
                            borderColor: item.color,
                            borderWidth: 1
                        };
                    })
                },
                options: {
                    responsive: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 20
                            }
                        },
                        tooltip: {
                            usePointStyle: true,
                            itemSort: function(a, b) { return b.raw - a.raw; }
                        }
                    }
                }
            });
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initStoryPointsChart);
    } else {
        initStoryPointsChart();
    }
})();
</script>
