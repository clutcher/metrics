<div class="box">
    <h3 class="title is-4">ðŸ“ˆ Developer Velocity (Last 6 Months{% if velocity_rolling_avg %}, {{ velocity_rolling_avg }}M Avg{% endif %})</h3>
    <div class="buttons are-small">
        <button class="button" id="showAll-dev-velocity">Show All</button>
        <button class="button" id="hideAll-dev-velocity">Hide All</button>
        <button class="button {% if velocity_rolling_avg %}is-info{% endif %}"
                hx-get="{% url 'ui_web:dev_velocity_chart' %}?member_group_id={{ member_group_id }}{% if not velocity_rolling_avg %}&rolling_avg=3{% endif %}"
                hx-target="#velocity-chart-container"
                hx-swap="innerHTML"
                hx-indicator="#loading-indicator">
            Rolling Average
        </button>
    </div>
    <canvas id="velocityChart" width="400" height="200"></canvas>
</div>

<script>
(function() {
    function initVelocityChart() {
        if (typeof Chart === 'undefined') {
            setTimeout(initVelocityChart, 100);
            return;
        }

        const showAllBtn = document.getElementById('showAll-dev-velocity');
        const hideAllBtn = document.getElementById('hideAll-dev-velocity');

        if (showAllBtn) {
            showAllBtn.addEventListener('click', () => {
                if (window.devVelocityChartInstance) {
                    window.devVelocityChartInstance.data.datasets.forEach((dataset, index) => {
                        window.devVelocityChartInstance.setDatasetVisibility(index, true);
                    });
                    window.devVelocityChartInstance.update();
                }
            });
        }

        if (hideAllBtn) {
            hideAllBtn.addEventListener('click', () => {
                if (window.devVelocityChartInstance) {
                    window.devVelocityChartInstance.data.datasets.forEach((dataset, index) => {
                        window.devVelocityChartInstance.setDatasetVisibility(index, false);
                    });
                    window.devVelocityChartInstance.update();
                }
            });
        }

        if (window.devVelocityChartInstance) {
            window.devVelocityChartInstance.destroy();
            window.devVelocityChartInstance = null;
        }

        const canvas = document.getElementById('velocityChart');
        if (!canvas) {
            console.error('Velocity chart canvas not found');
            return;
        }

        const chartData = {{ month_velocity|safe }};
        const thresholdsData = {{ velocity_thresholds|safe }};

        function hslToHsla(hsl, alpha) {
            return hsl.replace('hsl(', 'hsla(').replace(')', `, ${alpha})`);
        }

        function buildThresholdAnnotations(thresholds) {
            const annotations = {};
            const rangePercent = 0.25;

            thresholds.forEach((t) => {
                const rangeMin = t.threshold * (1 - rangePercent);
                const rangeMax = t.threshold * (1 + rangePercent);

                annotations[`band_${t.level_name}`] = {
                    type: 'box',
                    yMin: rangeMin,
                    yMax: rangeMax,
                    backgroundColor: hslToHsla(t.color, 0.04),
                    borderColor: hslToHsla(t.color, 0.2),
                    borderWidth: 1,
                    borderDash: [3, 3],
                    label: {
                        content: `${t.level_name} (~${t.threshold.toFixed(1)})`,
                        display: true,
                        position: 'end',
                        color: 'rgba(200, 200, 200, 0.6)'
                    }
                };
            });
            return annotations;
        }

        const thresholdAnnotations = buildThresholdAnnotations(thresholdsData.thresholds);

        if (chartData && chartData.labels && chartData.data) {
            window.devVelocityChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: chartData.labels,
                    datasets: chartData.data.map(item => ({
                        label: item.developer,
                        data: item.metrics.map(value => value === 0 ? null : value),
                        borderColor: item.color,
                        backgroundColor: item.color,
                        fill: false,
                        tension: 0.1,
                        spanGaps: true
                    }))
                },
                options: {
                    responsive: true,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: thresholdAnnotations
                        },
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 20
                            }
                        },
                        tooltip: {
                            usePointStyle: true,
                            itemSort: (a, b) => b.raw - a.raw
                        }
                    }
                }
            });
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initVelocityChart);
    } else {
        initVelocityChart();
    }
})();
</script>
