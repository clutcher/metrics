{% if error %}
<article class="message is-danger">
    <div class="message-header">
        <p>‚ö†Ô∏è Error Loading Velocity Data</p>
    </div>
    <div class="message-body">
        <p><strong>{{ error }}</strong></p>
        {% if config_help %}
            <p>{{ config_help }}</p>
            <p>Please contact your system administrator to configure the required data source.</p>
        {% else %}
            <p>Please check your configuration or try refreshing the page.</p>
        {% endif %}
    </div>
</article>
{% else %}
<div class="box">
    <h3 class="title is-4">üìà Developer Velocity (Last 6 Months)</h3>
    <div class="buttons are-small">
        <button class="button" id="showAll-dev-velocity">Show All</button>
        <button class="button" id="hideAll-dev-velocity">Hide All</button>
    </div>
    <canvas id="monthVelocityChart-{{ request.resolver_match.kwargs.team_id|default:'default' }}-{{ request.GET.member_group_id|default:'all' }}" width="400" height="200"></canvas>
</div>

<div class="box">
    <h3 class="title is-4">üìä Developer Story Points (Last 6 Months)</h3>
    <div class="buttons are-small">
        <button class="button" id="showAll-dev-sp">Show All</button>
        <button class="button" id="hideAll-dev-sp">Hide All</button>
    </div>
    <canvas id="monthStoryPointChart-{{ request.resolver_match.kwargs.team_id|default:'default' }}-{{ request.GET.member_group_id|default:'all' }}" width="400" height="200"></canvas>
</div>

<script>
{% if not error %}
function initializeDevVelocityCharts() {
    document.getElementById('showAll-dev-velocity').addEventListener('click', () => {
        if (window.devVelocityChartInstance) {
            window.devVelocityChartInstance.data.datasets.forEach(dataset => {
                dataset.hidden = false;
            });
            window.devVelocityChartInstance.update();
        }
    });

    document.getElementById('hideAll-dev-velocity').addEventListener('click', () => {
        if (window.devVelocityChartInstance) {
            window.devVelocityChartInstance.data.datasets.forEach(dataset => {
                dataset.hidden = true;
            });
            window.devVelocityChartInstance.update();
        }
    });

    document.getElementById('showAll-dev-sp').addEventListener('click', () => {
        if (window.devStoryPointsChartInstance) {
            window.devStoryPointsChartInstance.data.datasets.forEach(dataset => {
                dataset.hidden = false;
            });
            window.devStoryPointsChartInstance.update();
        }
    });

    document.getElementById('hideAll-dev-sp').addEventListener('click', () => {
        if (window.devStoryPointsChartInstance) {
            window.devStoryPointsChartInstance.data.datasets.forEach(dataset => {
                dataset.hidden = true;
            });
            window.devStoryPointsChartInstance.update();
        }
    });

    if (typeof Chart === 'undefined') {
        console.log('Chart.js not loaded yet, waiting...');
        setTimeout(initializeDevVelocityCharts, 100);
        return;
    }

    const velocityCanvasId = 'monthVelocityChart-{{ request.resolver_match.kwargs.team_id|default:"default" }}-{{ request.GET.member_group_id|default:"all" }}';
    const storyPointsCanvasId = 'monthStoryPointChart-{{ request.resolver_match.kwargs.team_id|default:"default" }}-{{ request.GET.member_group_id|default:"all" }}';

    if (window.devVelocityChartInstance) {
        window.devVelocityChartInstance.destroy();
        window.devVelocityChartInstance = null;
    }
    if (window.devStoryPointsChartInstance) {
        window.devStoryPointsChartInstance.destroy();
        window.devStoryPointsChartInstance = null;
    }

    const velocityCanvas = document.getElementById(velocityCanvasId);
    const storyPointsCanvas = document.getElementById(storyPointsCanvasId);
    
    if (!velocityCanvas || !storyPointsCanvas) {
        console.error('Canvas elements not found');
        return;
    }

    const monthVelocityData = {{ month_velocity|safe }};
    const monthStoryPointsData = {{ month_sp|safe }};

    const monthVelocityCtx = velocityCanvas.getContext('2d');

    if (monthVelocityData && monthVelocityData.labels && monthVelocityData.data) {
        window.devVelocityChartInstance = new Chart(monthVelocityCtx, {
            type: 'line',
            data: {
                labels: monthVelocityData.labels,
                datasets: monthVelocityData.data.map(item => ({
                    label: item.developer,
                    data: item.metrics.map(value => value === 0 ? null : value),
                    borderColor: item.color,
                    backgroundColor: item.color,
                    fill: false,
                    tension: 0.1,
                    spanGaps: true
                }))
            },
            options: {
                responsive: true,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 20
                        }
                    },
                    tooltip: {
                        usePointStyle: true,
                        itemSort: (a, b) => b.raw - a.raw
                    }
                }
            }
        });
    }

    const monthStoryPointsCtx = storyPointsCanvas.getContext('2d');

    if (monthStoryPointsData && monthStoryPointsData.labels && monthStoryPointsData.data) {
        window.devStoryPointsChartInstance = new Chart(monthStoryPointsCtx, {
            type: 'bar',
            data: {
                labels: monthStoryPointsData.labels,
                datasets: monthStoryPointsData.data.map(item => ({
                    label: item.developer,
                    data: item.metrics,
                    backgroundColor: item.color,
                    borderColor: item.color,
                    borderWidth: 1
                }))
            },
            options: {
                responsive: true,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            boxWidth: 12,
                            padding: 20
                        }
                    },
                    tooltip: {
                        usePointStyle: true,
                        itemSort: (a, b) => b.raw - a.raw
                    }
                }
            }
        });
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeDevVelocityCharts);
} else {
    initializeDevVelocityCharts();
}
{% endif %}
</script>
{% endif %}